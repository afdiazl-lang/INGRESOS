<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Paquetes - Bodega</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Estilos personalizados para el esc√°ner */
        #scanner-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
        }

        #scanner-video {
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
        }

        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 50%;
            border: 3px solid #10b981;
            border-radius: 0.5rem;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #10b981;
            animation: scan 2s linear infinite;
        }

        @keyframes scan {
            0%, 100% { top: 0; }
            50% { top: 100%; }
        }

        /* Animaci√≥n de √©xito */
        @keyframes success-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .success-animation {
            animation: success-pulse 0.5s ease-in-out;
        }

        /* Estilos para la tabla responsive */
        .table-container {
            overflow-x: auto;
        }

        /* Mejora visual para dispositivos m√≥viles */
        @media (max-width: 640px) {
            .mobile-card {
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                padding: 1rem;
                margin-bottom: 1rem;
                background: white;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-center">üì¶ Registro de Paquetes</h1>
            <p class="text-center text-blue-100 mt-2">Sistema de Gesti√≥n de Bodega</p>
            <p id="app-version" class="text-center text-blue-200 text-xs mt-2"></p>
        </header>

        <!-- Secci√≥n de Escaneo -->
        <div id="scan-section" class="bg-white rounded-lg shadow-md p-6 mb-6">
            <button id="start-scan-btn"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition duration-200 transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-wait">
                üì∑ Escanear C√≥digo
            </button>

            <!-- Contenedor del esc√°ner (oculto por defecto) -->
            <div id="scanner-container" class="hidden mt-4">
                <div class="relative">
                    <video id="scanner-video" playsinline></video>
                    <canvas id="qr-canvas" class="hidden"></canvas>
                    <div class="scanner-overlay">
                        <div class="scan-line"></div>
                    </div>
                </div>
                <div class="mt-4">
                    <button id="stop-scan-btn"
                            class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                        ‚èπÔ∏è Detener Escaneo
                    </button>
                </div>
                <p class="text-center text-gray-600 mt-2" id="scanner-status">Apunte la c√°mara al c√≥digo...</p>
            </div>

            <!-- Entrada Manual -->
            <div class="mt-6 pt-4 border-t border-gray-200">
                <p class="text-center text-gray-500 mb-3 text-sm">¬øEl c√≥digo est√° da√±ado? Ingr√©selo manualmente:</p>
                <form id="manual-entry-form" class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="manual-tracking-input"
                           placeholder="N√∫mero de seguimiento manual"
                           class="flex-grow w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit"
                            class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-5 rounded-lg transition duration-200">
                        Continuar ‚û°Ô∏è
                    </button>
                </form>
            </div>
        </div>

        <!-- Mensaje de √©xito -->
        <div id="success-message" class="hidden bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-lg mb-6">
            <p class="font-bold">‚úÖ C√≥digo escaneado exitosamente</p>
            <p id="success-code" class="text-sm"></p>
        </div>

        <!-- Mensaje de registro guardado -->
        <div id="save-success-message" class="hidden bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg mb-6">
            <p class="font-bold">‚úÖ Paquete registrado exitosamente</p>
            <p class="text-sm">El registro ha sido guardado en la lista.</p>
        </div>

        <!-- Formulario de Registro -->
        <div id="form-section" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìù Registro de Paquete</h2>
            <form id="package-form">
                <div class="mb-4">
                    <label class="block text-gray-700 font-bold mb-2" for="tracking-number">
                        N√∫mero de Seguimiento *
                    </label>
                    <input type="text"
                           id="tracking-number"
                           required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Ingrese o escanee el n√∫mero de seguimiento">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 font-bold mb-2" for="customer-name">
                        Nombre del Cliente *
                    </label>
                    <input type="text"
                           id="customer-name"
                           required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Ingrese el nombre del cliente">
                </div>

                <div class="mb-4 flex items-center">
                    <input type="checkbox" id="keep-customer-checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="keep-customer-checkbox" class="ml-2 block text-sm text-gray-900">
                        Mantener cliente y notas para el siguiente registro
                    </label>
                </div>



                <div class="mb-4">
                    <label class="block text-gray-700 font-bold mb-2" for="weight">
                        Peso (opcional)
                    </label>
                    <input type="text"
                           id="weight"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Ej: 2.5 kg, 5 lbs">
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 font-bold mb-2" for="notes">
                        Notas Adicionales
                    </label>
                    <textarea id="notes"
                              rows="3"
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Informaci√≥n adicional (opcional)"></textarea>
                </div>

                <div class="flex gap-3">
                    <button type="submit"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-200">
                        üíæ Guardar Registro
                    </button>
                    <button type="button"
                            id="cancel-btn"
                            class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                        ‚ùå Cancelar
                    </button>
                </div>
            </form>
        </div>

        <!-- Lista de Registros -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4 flex-wrap gap-3">
                <h2 class="text-2xl font-bold text-gray-800">üìã Registros</h2>
                <div class="flex gap-2">
                    <button id="export-excel-btn"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 text-sm">
                        üì• Exportar Excel
                    </button>
                    <button id="clear-all-btn"
                            class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 text-sm">
                        üóëÔ∏è Limpiar Todo
                    </button>
                </div>
            </div>

            <div id="records-count" class="text-gray-600 mb-4">
                Total de registros: <span id="total-count" class="font-bold">0</span>
            </div>

            <!-- Vista de escritorio: Tabla -->
            <div class="hidden md:block table-container">
                <table class="w-full">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-4 py-3 text-left text-gray-700 font-bold">N¬∫ Seguimiento</th>
                            <th class="px-4 py-3 text-left text-gray-700 font-bold">Cliente</th>
                            <th class="px-4 py-3 text-left text-gray-700 font-bold">Notas</th>
                            <th class="px-4 py-3 text-left text-gray-700 font-bold">Peso</th>
                            <th class="px-4 py-3 text-left text-gray-700 font-bold">Fecha/Hora</th>
                            <th class="px-4 py-3 text-center text-gray-700 font-bold">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="records-table">
                        <!-- Los registros se cargar√°n aqu√≠ din√°micamente -->
                    </tbody>
                </table>
            </div>

            <!-- Vista m√≥vil: Cards -->
            <div id="records-mobile" class="md:hidden">
                <!-- Los registros se cargar√°n aqu√≠ como cards -->
            </div>

            <div id="no-records" class="text-center text-gray-500 py-8">
                No hay registros a√∫n. Comienza escaneando un paquete.
            </div>
        </div>
    </div>

    <!-- LIBRER√çAS EXTERNAS (CDN) -->
    <!-- ZXing (Esc√°ner de c√≥digos) -->
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest/umd/zxing.min.js"></script>
    <!-- SheetJS (Exportaci√≥n a Excel) -->
    <script type="text/javascript" src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <!-- SCRIPT PRINCIPAL DE LA APLICACI√ìN -->
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        const APP_VERSION = '1.9.3'; // <-- ¬°Actualiza la versi√≥n aqu√≠!

        let isScanning = false;
        let audioCtx; // Para el sonido de "bip"
        let zxingCodeReader; // Lector de c√≥digos unificado

        // ==========================================
        // ELEMENTOS DEL DOM
        // ==========================================
        const startScanBtn = document.getElementById('start-scan-btn');
        const stopScanBtn = document.getElementById('stop-scan-btn');
        const scannerContainer = document.getElementById('scanner-container');
        const scannerStatus = document.getElementById('scanner-status');
        const successMessage = document.getElementById('success-message');
        const successCode = document.getElementById('success-code');
        const saveSuccessMessage = document.getElementById('save-success-message');
        const formSection = document.getElementById('form-section');
        const packageForm = document.getElementById('package-form');
        const trackingNumberInput = document.getElementById('tracking-number');
        const customerNameInput = document.getElementById('customer-name');
        const keepCustomerCheckbox = document.getElementById('keep-customer-checkbox');
        const notesInput = document.getElementById('notes');
        const weightInput = document.getElementById('weight');
        const cancelBtn = document.getElementById('cancel-btn');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const recordsTable = document.getElementById('records-table');
        const recordsMobile = document.getElementById('records-mobile');
        const noRecords = document.getElementById('no-records');
        const totalCount = document.getElementById('total-count');
        const qrCanvas = document.getElementById('qr-canvas');
        const manualEntryForm = document.getElementById('manual-entry-form');
        const manualTrackingInput = document.getElementById('manual-tracking-input');

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('app-version').textContent = `v${APP_VERSION}`;
            loadRecords();
            setupEventListeners();
        });

        // ==========================================
        // EVENT LISTENERS
        // ==========================================
        function setupEventListeners() {
            startScanBtn.addEventListener('click', startScanning);
            stopScanBtn.addEventListener('click', stopScanning);
            packageForm.addEventListener('submit', handleFormSubmit);
            cancelBtn.addEventListener('click', cancelForm);
            exportExcelBtn.addEventListener('click', exportToExcel);
            clearAllBtn.addEventListener('click', clearAllRecords);
            manualEntryForm.addEventListener('submit', handleManualEntry);
        }



        // ==========================================
        // FUNCIONES DE ESCANEO
        // ==========================================
        function initAudioContext() {
            if (!audioCtx) {
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.error("Web Audio API no es compatible con este navegador.");
                }
            }
        }

        async function startScanning() {
            scannerContainer.classList.remove('hidden');
            startScanBtn.classList.add('hidden');
            isScanning = true;
            scannerStatus.textContent = 'Iniciando c√°mara...';

            await startUnifiedScanner();
            
            initAudioContext();

            manualTrackingInput.value = '';
        }

        function stopScanning() {
            isScanning = false;
            scannerContainer.classList.add('hidden');
            startScanBtn.classList.remove('hidden');

            if (zxingCodeReader) {
                zxingCodeReader.reset(); // El m√©todo reset se encarga de detener el stream y liberar la c√°mara.
            }
        }

        async function startUnifiedScanner() {
            try {
                zxingCodeReader = new ZXing.BrowserMultiFormatReader();
                const videoInputDevices = await zxingCodeReader.listVideoInputDevices();
                let selectedDeviceId = null;
        
                if (videoInputDevices.length > 0) {
                    // Intenta encontrar la c√°mara trasera ('back' o 'trasera')
                    const rearCamera = videoInputDevices.find(device => /back|rear|trasera/i.test(device.label));
                    // Si no la encuentra, usa la primera c√°mara de la lista
                    selectedDeviceId = rearCamera ? rearCamera.deviceId : videoInputDevices[0].deviceId;
                }
        
                if (!selectedDeviceId) {
                    throw new Error('No se encontr√≥ ninguna c√°mara.');
                }
        
                scannerStatus.textContent = 'Apunte la c√°mara al c√≥digo...';
        
                // Usamos decodeFromVideoDevice que maneja el stream y el video autom√°ticamente.
                zxingCodeReader.decodeFromVideoDevice(selectedDeviceId, 'scanner-video', (result, err) => {
                    if (result && isScanning) {
                        onCodeScanned(result.getText());
                    }
                });
            } catch (err) {
                console.error('Error al acceder a la c√°mara:', err);
                handleCameraError(err);
            }
        }

        // ==========================================
        // MANEJO DE C√ìDIGO ESCANEADO
        // ==========================================
        function onCodeScanned(code, source = 'scanner') {
            if (!isScanning && source === 'scanner') return;
            
            playBeepSound();

            stopScanning(); // Detenemos todo una vez que tenemos un c√≥digo.

            successCode.textContent = `C√≥digo: ${code}`;
            successMessage.classList.remove('hidden');
            successMessage.classList.add('success-animation');

            trackingNumberInput.value = code;
            formSection.classList.remove('hidden');

            formSection.scrollIntoView({ behavior: 'smooth' });

            setTimeout(() => {
                customerNameInput.focus();
            }, 500);

            setTimeout(() => {
                successMessage.classList.add('hidden');
            }, 3000);
        }

        // ==========================================
        // MANEJO DEL FORMULARIO
        // ==========================================
        function handleFormSubmit(e) {
            e.preventDefault();

            const record = {
                id: Date.now(),
                trackingNumber: trackingNumberInput.value.trim(),
                customerName: customerNameInput.value.trim(),
                notes: notesInput.value.trim(),
                weight: weightInput.value.trim(),
                timestamp: new Date().toISOString()
            };

            if (!record.trackingNumber || !record.customerName) {
                alert('Por favor, complete todos los campos obligatorios.');
                return;
            }

            saveRecord(record);

            // Limpiar formulario seg√∫n la opci√≥n "mantener cliente"
            if (keepCustomerCheckbox.checked) {
                trackingNumberInput.value = '';
                weightInput.value = ''; // Limpiar tambi√©n el peso
                // Mantenemos el nombre y las notas, y ocultamos el formulario
                formSection.classList.add('hidden');
                // Movemos el foco al bot√≥n de escanear para agilizar el siguiente registro
                setTimeout(() => {
                    startScanBtn.focus();
                    startScanBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);

            } else {
                packageForm.reset();
                formSection.classList.add('hidden');
            }

            loadRecords();
            showSaveSuccessMessage();
        }

        function showSaveSuccessMessage() {
            saveSuccessMessage.classList.remove('hidden');
            saveSuccessMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => {
                saveSuccessMessage.classList.add('hidden');
            }, 3000);
        }

        function cancelForm() {
            if (confirm('¬øDesea cancelar el registro actual?')) {
                packageForm.reset();
                formSection.classList.add('hidden');
                successMessage.classList.add('hidden');
            }
        }
        // ==========================================
        // MANEJO DE ENTRADA MANUAL
        // ==========================================
        function handleManualEntry(e) {
            e.preventDefault();
            const code = manualTrackingInput.value.trim();

            if (code) {
                onCodeScanned(code, 'manual');
                manualTrackingInput.value = '';
            } else {
                alert('Por favor, ingrese un n√∫mero de seguimiento.');
            }
        }

        // ==========================================
        // LOCAL STORAGE
        // ==========================================
        function saveRecord(record) {
            const records = getRecords();
            records.push(record);
            localStorage.setItem('packageRecords', JSON.stringify(records));
        }

        function getRecords() {
            const records = localStorage.getItem('packageRecords');
            return records ? JSON.parse(records) : [];
        }

        function deleteRecord(id) {
            if (confirm('¬øEst√° seguro de eliminar este registro?')) {
                const records = getRecords().filter(r => r.id !== id);
                localStorage.setItem('packageRecords', JSON.stringify(records));
                loadRecords();
            }
        }

        function clearAllRecords() {
            if (confirm('‚ö†Ô∏è ¬øEst√° seguro de eliminar TODOS los registros? Esta acci√≥n no se puede deshacer.')) {
                if (confirm('Confirme nuevamente: Se eliminar√°n todos los registros permanentemente.')) {
                    localStorage.removeItem('packageRecords');
                    loadRecords();
                    alert('Todos los registros han sido eliminados.');
                }
            }
        }

        // ==========================================
        // RENDERIZADO DE REGISTROS
        // ==========================================
        function loadRecords() {
            const records = getRecords();
            const recordsTableBody = document.getElementById('records-table');
            const recordsMobileContainer = document.getElementById('records-mobile');

            recordsTableBody.innerHTML = '';
            recordsMobileContainer.innerHTML = '';

            totalCount.textContent = records.length;

            if (records.length === 0) {
                noRecords.classList.remove('hidden');
                recordsTable.innerHTML = '';
                recordsMobile.innerHTML = '';
                return;
            }

            noRecords.classList.add('hidden');

            records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            records.forEach(record => {
                // Vista de escritorio
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 font-mono text-sm">${escapeHtml(record.trackingNumber)}</td>
                    <td class="px-4 py-3">${escapeHtml(record.customerName)}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${escapeHtml(record.notes || '-')}</td>
                    <td class="px-4 py-3 text-sm">${escapeHtml(record.weight || '-')}</td>
                    <td class="px-4 py-3 text-sm">${formatDateTime(record.timestamp)}</td>
                    <td class="px-4 py-3 text-center">
                        <button data-record-id="${record.id}" class="delete-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition duration-200">
                            üóëÔ∏è
                        </button>
                    </td>`;
                recordsTableBody.appendChild(row);

                // Vista m√≥vil
                const card = document.createElement('div');
                card.className = 'mobile-card';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <p class="text-xs text-gray-500 mb-1">N√∫mero de Seguimiento</p>
                            <p class="font-mono font-bold text-sm break-all">${escapeHtml(record.trackingNumber)}</p>
                        </div>
                        <button data-record-id="${record.id}" class="delete-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm ml-2">
                            üóëÔ∏è
                        </button>
                    </div>
                    <div class="mb-2">
                        <p class="text-xs text-gray-500">Cliente</p>
                        <p class="font-semibold">${escapeHtml(record.customerName)}</p>
                    </div>
                    ${record.notes ? `<div class="mb-2">
                        <p class="text-xs text-gray-500">Notas</p>
                        <p class="text-sm text-gray-600">${escapeHtml(record.notes)}</p>
                    </div>` : ''}
                    ${record.weight ? `<div class="mb-2">
                        <p class="text-xs text-gray-500">Peso</p>
                        <p class="text-sm">${escapeHtml(record.weight)}</p>
                    </div>` : ''}
                    <div>
                        <p class="text-xs text-gray-500">Fecha y Hora</p>
                        <p class="text-sm">${formatDateTime(record.timestamp)}</p>
                    </div>`;
                recordsMobileContainer.appendChild(card);
            });

            // Asignar eventos a los nuevos botones de eliminar
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = parseInt(e.currentTarget.getAttribute('data-record-id'));
                    deleteRecord(id);
                });
            });
        }

        // ==========================================
        // EXPORTACI√ìN A EXCEL
        // ==========================================
        function exportToExcel() {
            if (typeof XLSX === 'undefined') {
                alert('La librer√≠a de exportaci√≥n a√∫n no est√° lista. Por favor, espere un momento e intente de nuevo.');
                return;
            }

            const records = getRecords();

            if (records.length === 0) {
                alert('No hay registros para exportar.');
                return;
            }

            const data = records.map(record => ({
                'N√∫mero de Seguimiento': record.trackingNumber,
                'Nombre del Cliente': record.customerName,
                'Notas': record.notes || '',
                'Peso': record.weight || '',
                'Fecha y Hora': formatDateTime(record.timestamp)
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Registros");

            const colWidths = [
                { wch: 25 },
                { wch: 30 },
                { wch: 40 },
                { wch: 15 },
                { wch: 20 }
            ];
            ws['!cols'] = colWidths;

            const fileName = `registros-paquetes-${formatDateForFilename()}.xlsx`;
            XLSX.writeFile(wb, fileName);

            alert(`‚úÖ Archivo exportado: ${fileName}`);
        }

        // ==========================================
        // UTILIDADES
        // ==========================================
        function formatDateTime(timestamp) {
            const date = new Date(timestamp);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }

        function formatDateForFilename() {
            const date = new Date();
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${year}${month}${day}`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function handleCameraError(err) {
            let message = 'üî¥ No se pudo acceder a la c√°mara.\n\nPosibles causas:\n\n';

            if (window.location.protocol !== 'https:' && !['localhost', '127.0.0.1'].includes(window.location.hostname)) {
                message += '‚Ä¢ CONEXI√ìN NO SEGURA: Las c√°maras web solo funcionan en sitios seguros (https://) o en un servidor local (localhost).\n\n';
            }

            switch(err.name) {
                case 'NotAllowedError':
                case 'PermissionDeniedError':
                    message += '‚Ä¢ PERMISO DENEGADO: Has bloqueado el acceso a la c√°mara. Revisa los permisos del sitio en la configuraci√≥n de tu navegador.\n';
                    break;
                case 'NotFoundError':
                case 'DevicesNotFoundError':
                    message += '‚Ä¢ C√ÅMARA NO ENCONTRADA: No se encontr√≥ una c√°mara compatible en tu dispositivo.\n';
                    break;
                case 'NotReadableError':
                case 'TrackStartError':
                    message += '‚Ä¢ ERROR DE HARDWARE: La c√°mara ya est√° siendo usada por otra aplicaci√≥n o hay un problema con el sistema operativo.\n';
                    break;
            }
            alert(message);
            stopScanning();
        }

        function playBeepSound() {
            if (!audioCtx) return;

            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);

            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.1);
        }
    </script>
</body>
</html>
